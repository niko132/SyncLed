<html>
    <head>
        <link href="https://fonts.googleapis.com/css?family=Noto Sans" rel="stylesheet">
        <link rel="stylesheet" href="index1.css">
        <script>
const EFFECT_IDS = [1, 2, 3, 4, 5, 6];
const EFFECT_NAMES = ['Static', 'Fade', 'Cycle', 'Dot', 'PingPong', 'Firework'];

var PALETTE_IDS = [];
var PALETTE_NAMES = [];

const host = window.location.hostname || '192.168.3.9';
var ws;

var currentCfg = {};

var currentTab = 1;

document.addEventListener("DOMContentLoaded", function(){
    navigation(0);
    loadPage();
});

function loadPage() {
    ws = new WebSocket(`ws://${host}/ws`);

    ws.onopen = function() {
        console.log("ws opened");
    };

    ws.onmessage = function(evt) {
        console.log("ws message");

        var msg = evt.data;
        console.log(msg);

        const cfg = JSON.parse(msg);

        const vdIds = cfg['vdIds'];
        const vds = cfg['vds'];
        const pIds = cfg['pIds'];
        const ps = cfg['ps'];
        const prstIds = cfg['prstIds'];
        const prsts = cfg['prsts'];
        const actDev = cfg['actDev'];
        const pllstIds = cfg['pllstIds'];
        const pllsts = cfg['pllsts'];

        const on = cfg['on'] || false;


        if (pIds || ps) {
            if (pIds) {
                currentCfg['pIds'] = pIds;
            }
            if (ps) {
                currentCfg['ps'] = ps;
            }
            updatePalettes();
            updatePaletteList();
        }


        if (prstIds || prsts || actDev) {
            if (prstIds) {
                currentCfg['prstIds'] = prstIds;
            }
            if (prsts) {
                currentCfg['prsts'] = prsts;
            }
            if (actDev) {
                currentCfg['actDev'] = actDev;
                console.log('new devices');
                console.log(currentCfg);
            }
            updatePresetChips();
            updatePresetList();
        }


        if (pllstIds || pllsts) {
            if (pllstIds) {
                currentCfg['pllstIds'] = pllstIds;
            }

            if (pllsts) {
                currentCfg['pllsts'] = pllsts;
            }
            updatePlaylistList();
        }


        if (vdIds || vds) {
            if (vdIds) {
                currentCfg['vdIds'] = vdIds;
            }
            if (vds) {
                currentCfg['vds'] = vds;
            }
            updateVDList();
        }


        if ('on' in cfg) {
            currentCfg['on'] = on;
        }

        // currentCfg = JSON.parse(msg);





        // update power button
        const onValue = currentCfg['on'];
        const powerButtonElement = document.getElementById('power-btn');
        if (onValue) {
            powerButtonElement.classList.remove('vd-btn-off');
            powerButtonElement.classList.add('vd-btn-on');
        } else {
            powerButtonElement.classList.remove('vd-btn-on');
            powerButtonElement.classList.add('vd-btn-off');
        }
    };

    ws.onclose = function() {
        console.log("ws closed");
    };
};

function jsonButtonClick() {
    var jsonTextArea = document.getElementById("jsonTextArea");
    var jsonText = jsonTextArea.value;

    ws.send(jsonText);
};

function updatePalettes() {
    const ps = currentCfg['ps'];

    const ids = [];
    const names = [];

    for (var i = 0; i < ps.length; i++) {
        const p = ps[i];
        const id = parseInt(p['id']);
        const name = p['n'];

        ids.push(id);
        names.push(name);
    }

    PALETTE_IDS = ids;
    PALETTE_NAMES = names;

    const paletteDDs = document.getElementsByClassName('palette-dd');
    for (var i = 0; i < paletteDDs.length; i++) {
        const paletteDD = paletteDDs[i];
        const newPaletteDD = createDropdown(PALETTE_IDS, PALETTE_NAMES, paletteDD.value, paletteDD.onchange);
        newPaletteDD.classList.add('palette-dd');
        paletteDD.parentElement.replaceChild(newPaletteDD, paletteDD);
    }
};

function createSlider(min, max, current, oninput) {
    var element = document.createElement('span');
    element.style.position = 'relative';

    const output = document.createElement('output');
    output.classList.add('slider-output');

    const adjustBackground = function(val) {
        const perc = (val - min) / (max - min) * 100;

        const sliderWidth = slider.offsetWidth;
        const thumbWidth = slider.offsetHeight * 2; // TODO: fineadjust
        const pos = thumbWidth / 2.0 / sliderWidth * 100 + perc * (sliderWidth - thumbWidth) / sliderWidth;

        slider.style.background = `linear-gradient(to right, #c6bcbf ${pos}%, #0008 ${pos}%)`;


        const bubbleWidth = output.offsetWidth;
        const pos1 = -bubbleWidth / 2.0 + pos / 100.0 * sliderWidth;
        output.style.left = `${pos1}px`;
        output.innerHTML = `<span>${val}</span>`;
    };

    var slider = document.createElement('input');
    slider.type = 'range';
    slider.min = min;
    slider.max = max;
    slider.value = current;
    slider.onchange = oninput;
    slider.oninput = function() {
        var val = parseInt(slider.value);
        adjustBackground(val);
    };
    slider.classList.add('def-slider');
    element.appendChild(slider);

    element.appendChild(output);

    // needed to init background
    new ResizeObserver(function() {
        adjustBackground(slider.value);
    }).observe(slider);
    new ResizeObserver(function() {
        adjustBackground(slider.value);
    }).observe(output);


    return element;
};

function createBriSlider(min, max, current, oninput) {
    var element = document.createElement('span');
    element.style.position = 'relative';

    const adjustBackground = function(val) {
        const perc = (val - min) / (max - min) * 100;

        const sliderWidth = slider.offsetWidth;
        const thumbWidth = slider.offsetHeight;
        var pos = thumbWidth / 2.0 / sliderWidth * 100 + perc * (sliderWidth - thumbWidth) / sliderWidth;

        slider.style.background = `linear-gradient(to right, #c6bcbf ${pos}%, #0008 ${pos}%)`;
    };

    const slider = document.createElement('input');
    slider.type = 'range';
    slider.min = min;
    slider.max = max;
    slider.value = current;
    slider.onchange = oninput;
    slider.oninput = function() {
        var val = parseInt(slider.value);
        adjustBackground(val);
    };
    slider.classList.add('bri-slider');
    element.appendChild(slider);

    // needed to init background
    new ResizeObserver(function() {
        adjustBackground(slider.value);
    }).observe(slider);

    return element;
};

function createDualSlider(min, max, current1, current2, oninput1, oninput2) {
    var element = document.createElement('span');
    element.classList.add('multi-range');

    var input1 = document.createElement('input');
    var input2 = document.createElement('input');

    const output = document.createElement('output');
    output.classList.add('slider-output');

    const adjustBackground = function() {
        const lower = input1.value;
        const upper = input2.value;

        const perc1 = (lower - min) / (max - min) * 100;
        const perc2 = (upper - min) / (max - min) * 100;

        const sliderWidth = input1.offsetWidth;
        const thumbWidth = input1.offsetHeight * 2;
        const pos1 = thumbWidth / 2.0 / sliderWidth * 100 + perc1 * (sliderWidth - thumbWidth) / sliderWidth;
        const pos2 = thumbWidth / 2.0 / sliderWidth * 100 + perc2 * (sliderWidth - thumbWidth) / sliderWidth;

        input1.style.background = `linear-gradient(to right, #0008 ${pos1}%, #c6bcbf ${pos1}%, #c6bcbf ${pos2}%, #0008 ${pos2}%) no-repeat center`;
        input1.style.backgroundOrigin = 'content-box';
    };

    const adjustBubble = function(val) {
        var pos = (val - min) / (max - min) * 100;
        var posOffset = Math.round(16 * pos / 100) + 4;

        output.style.left = `calc(${pos}% - ${posOffset}px)`;
        output.innerHTML = `<span>${val}</span>`;
    };

    input1.type = 'range';
    input1.min = min;
    input1.max = max;
    input1.value = current1;
    input1.oninput = function() {
        var lowerVal = parseInt(input1.value);
        var upperVal = parseInt(input2.value);

        if (lowerVal >= upperVal) {
            input1.value = lowerVal = upperVal - 1;
        }

        adjustBackground();
        adjustBubble(lowerVal);
    };
    input1.onchange = oninput1;
    input1.classList.add('def-slider');
    input1.classList.add('dual-slider');
    element.appendChild(input1);

    input2.type = 'range';
    input2.min = min;
    input2.max = max;
    input2.value = current2;
    input2.oninput = function() {
        var lowerVal = parseInt(input1.value);
        var upperVal = parseInt(input2.value);

        if (upperVal <= lowerVal) {
            input2.value = upperVal = lowerVal + 1;
        }

        adjustBackground();
        adjustBubble(upperVal);
    };
    input2.onchange = oninput2;
    input2.classList.add('def-slider');
    input2.classList.add('dual-slider');
    element.appendChild(input2);

    element.appendChild(output);

    new ResizeObserver(function() {
        adjustBackground();
    }).observe(input1);
    new ResizeObserver(function() {
        adjustBackground();
    }).observe(input2);

    return element;
};

function createDropdown(values, names, current, onchange) {
    var element = document.createElement('select');

    for (var i = 0; i < values.length; i++) {
        var optionElem = document.createElement('option');
        optionElem.value = values[i];
        optionElem.text = names[i];
        element.appendChild(optionElem);
    }

    element.value = current;
    element.onchange = onchange;

    return element;
};

function createButton(text, onclick) {
    var element = document.createElement('button');
    element.innerHTML = text;
    element.onclick = onclick;

    return element;
};

function createSwitch(value, onchange) {
    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.checked = value;
    checkbox.onchange = function() {
        const val = this.checked;
        onchange(val);
    };

    return checkbox;
};

function generateId(disjunct) {
    if (!disjunct) {
        disjunct = [];
    }

    var id;
    do {
        // id = parseInt(Math.random() * 0xFFFFFFFF + 1); // no 0 // 32bit breaks ArduinoJson
        id = parseInt(Math.random() * 0x7FFFFFFF + 1); // use 31bit
    } while(disjunct.includes(id));

    return id;
};


function updatePresetChips() {
    const prsts = currentCfg['prsts'] || [];
    const parent = document.getElementById('preset-chips');
    parent.replaceChildren();

    for (var i = 0; i < prsts.length; i++) {
        const prst = prsts[i];
        const id = prst['id'];
        const n = prst['n'];

        const chipButton = createButton(n, function() {
            ws.send(JSON.stringify({prstId:id}));

            // TODO: update VD list
            // location.reload();

            const activeChips = document.getElementsByClassName('chip-active');
            for (const activeChip of activeChips) {
                activeChip.classList.remove('chip-active');
            }
            chipButton.classList.add('chip-active');
        });
        chipButton.classList.add('chip');
        parent.appendChild(chipButton);
    }
};


function updateVDList() {
    const vds = currentCfg['vds'];
    const parent = document.getElementById('vds-list');
    parent.replaceChildren(); // remove all children

    for (var i = 0; i < vds.length; i++) {
        const vd = vds[i];
        const id = vd['id']; // TODO: add defaults
        const n = vd['n'] || '';
        const sI = vd['sI'];
        const eI = vd['eI'];
        const eId = vd['eId'];
        const pId = vd['pId'];
        const eD = vd['eD'] || {};
        const on = vd['on'];
        const bri = vd['bri'];
        const m = vd['m'] || false;

        const spacingContainer = document.createElement('div');
        parent.appendChild(spacingContainer);

        const vdContainer = document.createElement('div');
        vdContainer.classList.add('card');
        vdContainer.classList.add('vd');
        spacingContainer.appendChild(vdContainer);


        const vdHeader = document.createElement('div');
        vdHeader.classList.add('vd-header');
        vdContainer.appendChild(vdHeader);

        const vdBody = document.createElement('div');
        vdBody.classList.add('vd-body');
        vdContainer.appendChild(vdBody);


        const nameInput = document.createElement('h2');
        nameInput.innerHTML = n;
        nameInput.classList.add('name-input');
        const submitName = function() {
            nameInput.contentEditable = 'false';

            const value = nameInput.innerHTML;
            vd['n'] = value;
            ws.send(JSON.stringify({vds:[{id:id,n:value}]}));
        };
        nameInput.addEventListener("keydown", function(event) {
            if (event.keyCode === 13) {
                event.preventDefault();
                submitName();
            }
        });
        nameInput.addEventListener('focusout', (event) => {
            submitName();
        });
        nameInput.disabled = true;
        vdHeader.appendChild(nameInput);

        const editButton = createButton('', function() {
            nameInput.contentEditable = 'true';
            nameInput.focus();
            var range = document.createRange()
            var sel = window.getSelection()

            range.setStart(nameInput.childNodes[0], nameInput.childNodes[0].length)
            range.collapse(true)

            sel.removeAllRanges()
            sel.addRange(range)
        });
        editButton.classList.add('edit-btn');
        vdHeader.appendChild(editButton);


        const deleteButton = createButton('', function() {
            const vdIds = currentCfg['vdIds'];

            const idIndex = vdIds.indexOf(id);
            if (idIndex > -1) {
                vdIds.splice(idIndex, 1);
            }

            const vdIndex = vds.map(vd => vd.id).indexOf(id);
            if (vdIndex > -1) {
                vds.splice(vdIndex, 1);
            }

            ws.send(JSON.stringify({vdIds:vdIds}));

            updateVDList();
        });
        deleteButton.classList.add('delete-btn1');
        vdHeader.appendChild(deleteButton);


        const brightnessSlider = createBriSlider(0, 255, bri, function() {
            const value = parseInt(this.value);
            vd['bri'] = value;
            ws.send(JSON.stringify({vds:[{id:id,bri:value}]}));
        });
        brightnessSlider.classList.add('grid-two-cols');
        vdBody.appendChild(brightnessSlider);



        const indexText = document.createElement('label');
        indexText.classList.add('grid-two-cols');
        indexText.innerHTML = 'Index:';
        vdBody.appendChild(indexText);

        const indexSlider = createDualSlider(0, 180, sI, eI, function() {
            const value = parseInt(this.value);
            vd['sI'] = value;
            ws.send(JSON.stringify({vds:[{id:id,sI:value}]}));
        }, function() {
            const value = parseInt(this.value);
            vd['eI'] = value;
            ws.send(JSON.stringify({vds:[{id:id,eI:value}]}));
        });
        indexSlider.classList.add('grid-two-cols');
        vdBody.appendChild(indexSlider);


        const mirrorText = document.createElement('label');
        mirrorText.classList.add('grid-two-cols');
        mirrorText.innerHTML = 'Mirror:';
        vdBody.appendChild(mirrorText);

        const mirrorSwitch = createSwitch(m, function(value) {
            vd['m'] = value;
            ws.send(JSON.stringify({vds:[{id:id,m:value}]}));
        });
        mirrorSwitch.classList.add('grid-two-cols');
        vdBody.appendChild(mirrorSwitch);


        const paletteDD = createDropdown(PALETTE_IDS, PALETTE_NAMES, pId, function() {
            const value = parseInt(this.value);
            vd['pId'] = value;
            ws.send(JSON.stringify({vds:[{id:id,pId:value}]}));
        });
        paletteDD.classList.add('palette-dd');
        vdBody.appendChild(paletteDD);

        const effectDD = createDropdown(EFFECT_IDS, EFFECT_NAMES, eId, function() {
            const value = parseInt(this.value);
            vd['eId'] = value;
            ws.send(JSON.stringify({vds:[{id:id,eId:value}]}));

            createEffectDataList(id, value, {}, effectDataContainer);
        });
        vdBody.appendChild(effectDD);

        const effectDataContainer = document.createElement('div');
        effectDataContainer.classList.add('grid-two-cols');
        vdBody.appendChild(effectDataContainer);

        createEffectDataList(id, eId, eD, effectDataContainer);
    }
}

function createEffectDataList(vdId, eId, eD, parent) {
    parent.replaceChildren();

    if (eId >= 1 && eId < 6) { // all cyclic effects
        const defD = (eD['d'] || 2000) / 100.0;
        const defSP = (eD['sP'] || 0) * 100;
        const defEP = (eD['eP'] || 1.0) * 100;

        const durationText = document.createElement('label');
        durationText.innerHTML = 'Duration:';
        parent.appendChild(durationText);

        const durationSlider = createSlider(10, 100, defD, function() {
            const value = parseInt(this.value) * 100;
            eD['d'] = value;
            ws.send(JSON.stringify({vds:[{id:vdId,eD:{d:value}}]}));
        });
        parent.appendChild(durationSlider);

        const posText = document.createElement('label');
        posText.innerHTML = 'Position:';
        parent.appendChild(posText);

        const posSlider = createDualSlider(0, 100, defSP, defEP, function() {
            const value = parseInt(this.value) / 100.0;
            eD['sP'] = value;
            ws.send(JSON.stringify({vds:[{id:vdId,eD:{sP:value}}]}));
        }, function() {
            const value = parseInt(this.value) / 100.0;
            eD['eP'] = value;
            ws.send(JSON.stringify({vds:[{id:vdId,eD:{eP:value}}]}));
        });
        parent.appendChild(posSlider);
    } else if (eId == 6) { // all simulation effects
        const defS = (eD['s'] || 1.0) * 10;

        const speedText = document.createElement('label');
        speedText.innerHTML = 'Speed:';
        parent.appendChild(speedText);

        const speedSlider = createSlider(1, 50, defS, function() {
            const value = parseInt(this.value) / 10.0;
            eD['s'] = value;
            ws.send(JSON.stringify({vds:[{id:vdId,eD:{s:value}}]}));
        });
        parent.appendChild(speedSlider);
    }

    // effect specific
    if (eId == 4 || eId == 5) {
        const defS = eD['s'] || 20.0;

        const sizeText = document.createElement('label');
        sizeText.innerHTML = 'Size:';
        parent.appendChild(sizeText);

        const sizeSlider = createSlider(1, 180, defS, function() {
            const value = parseInt(this.value);
            eD['s'] = value;
            ws.send(JSON.stringify({vds:[{id:vdId,eD:{s:value}}]}));
        });
        parent.appendChild(sizeSlider);
    }
}

function addVD() {
    console.log('add vd');

    const vdIds = currentCfg['vdIds'];

    const id = generateId(vdIds);
    vdIds.push(id);

    const newVd = {id:id,n:`VD #${id}`,sI:0,eI:20,eId:EFFECT_IDS[0],pId:PALETTE_IDS[0]};
    const vds = currentCfg['vds'];
    vds.push(newVd);

    ws.send(JSON.stringify({vdIds:vdIds,vds:[newVd]}));
    updateVDList();
};

function updatePaletteList() {
    const ps = currentCfg['ps'];
    const parent = document.getElementById('palettes-list');
    parent.replaceChildren(); // remove all children

    for (var i = 0; i < ps.length; i++) {
        const p = ps[i];
        const id = p['id']; // TODO: add defaults
        const n = p['n'];
        const ks = p['ks'] || [];

        const spacingContainer = document.createElement('div');
        parent.appendChild(spacingContainer);

        const pContainer = document.createElement('div');
        pContainer.classList.add('card');
        pContainer.classList.add('palette');
        spacingContainer.appendChild(pContainer);

        const pHeader = document.createElement('div');
        pHeader.classList.add('vd-header');
        pContainer.appendChild(pHeader);

        const nameInput = document.createElement('h2');
        nameInput.innerHTML = n;
        nameInput.classList.add('name-input');
        const submitName = function() {
            nameInput.contentEditable = 'false';

            const value = nameInput.innerHTML;
            p['n'] = value;
            ws.send(JSON.stringify({ps:[{id:id,n:value}]}));
            updatePalettes();
        };
        nameInput.addEventListener("keydown", function(event) {
            if (event.keyCode === 13) {
                event.preventDefault();
                submitName();
            }
        });
        nameInput.addEventListener('focusout', (event) => {
            submitName();
        });
        nameInput.disabled = true;
        pHeader.appendChild(nameInput);

        const editButton = createButton('', function() {
            nameInput.contentEditable = 'true';
            nameInput.focus();
            var range = document.createRange()
            var sel = window.getSelection()

            range.setStart(nameInput.childNodes[0], nameInput.childNodes[0].length)
            range.collapse(true)

            sel.removeAllRanges()
            sel.addRange(range)
        });
        editButton.classList.add('edit-btn');
        pHeader.appendChild(editButton);

        const deleteButton = createButton('', function() {
            const pIds = currentCfg['pIds'];

            const idIndex = pIds.indexOf(id);
            if (idIndex > -1) {
                pIds.splice(idIndex, 1);
            }

            const pIndex = ps.map(p => p.id).indexOf(id);
            if (pIndex > -1) {
                ps.splice(pIndex, 1);
            }

            ws.send(JSON.stringify({pIds:pIds}));

            updatePaletteList();
            updatePalettes();
        });
        deleteButton.classList.add('delete-btn1');
        // deleteButton.classList.add('palette-delete-btn');
        pHeader.appendChild(deleteButton);


        const pBody = document.createElement('div');
        pBody.classList.add('palette-body');
        pContainer.appendChild(pBody);

        const gp = new Grapick({el: pBody, max: 99, height: 48});

        for (const k of ks) {
            const p = k['p'];
            const c = k['c'];

            const pos = parseInt(p * 100);
            const color = '#' + c.toString(16).padStart(6, '0');

            gp.addHandler(pos, color);
        }

        gp.on('change', complete => {
            if (complete) {
                const ks = gp.getHandlers().map(handler => {
                    const color = parseInt(handler.getColor().substring(1), 16);
                    const pos = handler.getPosition() / 100.0;
                    return {p:pos,c:color};
                });

                p['ks'] = ks;
                ws.send(JSON.stringify({ps:[{id:id,ks:ks}]}));
            }
        });
    }
}

function addPalette() {
    console.log('add palette');

    const pIds = currentCfg['pIds'];

    const id = generateId(pIds);
    pIds.push(id);

    const newP = {id:id,n:`Palette #${id}`};
    const ps = currentCfg['ps'];
    ps.push(newP);

    ws.send(JSON.stringify({pIds:pIds,ps:[newP]}));
    updatePaletteList();

    // update vd palette list
    updatePalettes();
};

function updatePresetList() {
    const prsts = currentCfg['prsts'];
    const actDev = currentCfg['actDev'] || [];
    const parent = document.getElementById('presets-list');
    parent.replaceChildren(); // remove all children

    for (var i = 0; i < prsts.length; i++) {
        const prst = prsts[i];
        const id = prst['id']; // TODO: add defaults
        const n = prst['n'];
        const ips = prst['ips'] || [];



        const spacingContainer = document.createElement('div');
        parent.appendChild(spacingContainer);

        const presetContainer = document.createElement('div');
        presetContainer.classList.add('card');
        presetContainer.classList.add('palette');
        spacingContainer.appendChild(presetContainer);

        const presetHeader = document.createElement('div');
        presetHeader.classList.add('vd-header');
        presetContainer.appendChild(presetHeader);

        const nameInput = document.createElement('h2');
        nameInput.innerHTML = n;
        nameInput.classList.add('name-input');
        const submitName = function() {
            nameInput.contentEditable = 'false';

            const value = nameInput.innerHTML;
            prst['n'] = value;
            ws.send(JSON.stringify({prsts:[{id:id,n:value}]}));
        };
        nameInput.addEventListener("keydown", function(event) {
            if (event.keyCode === 13) {
                event.preventDefault();
                submitName();
            }
        });
        nameInput.addEventListener('focusout', (event) => {
            submitName();
        });
        nameInput.disabled = true;
        presetHeader.appendChild(nameInput);

        const editButton = createButton('', function() {
            nameInput.contentEditable = 'true';
            nameInput.focus();
            var range = document.createRange()
            var sel = window.getSelection()

            range.setStart(nameInput.childNodes[0], nameInput.childNodes[0].length)
            range.collapse(true)

            sel.removeAllRanges()
            sel.addRange(range)
        });
        editButton.classList.add('edit-btn');
        presetHeader.appendChild(editButton);

        const deleteButton = createButton('', function() {
            const prstIds = currentCfg['prstIds'];

            const idIndex = prstIds.indexOf(id);
            if (idIndex > -1) {
                prstIds.splice(idIndex, 1);
            }

            const prstIndex = prsts.map(prst => prst.id).indexOf(id);
            if (prstIndex > -1) {
                prsts.splice(prstIndex, 1);
            }

            ws.send(JSON.stringify({prstIds:prstIds}));

            updatePresetList();
            updatePresetChips();
            updatePlaylistList();
        });
        deleteButton.classList.add('delete-btn1');
        // deleteButton.classList.add('palette-delete-btn');
        presetHeader.appendChild(deleteButton);


        const presetBody = document.createElement('div');
        presetBody.classList.add('preset-body');
        presetContainer.appendChild(presetBody);


        const ipListContainer = document.createElement('div');
        presetBody.appendChild(ipListContainer);


        const createIpList = function(expanded = false) {
            ipListContainer.replaceChildren();

            const topIpListContainer = document.createElement('div');
            ipListContainer.appendChild(topIpListContainer);
//            for (const ip of ips.filter(ip => ip != localIP)) {
            for (const ip of ips) {
                const ipContainer = document.createElement('div');
                ipContainer.classList.add('ip-container');
                topIpListContainer.appendChild(ipContainer);

                const ipText = document.createElement('span');
                ipText.innerHTML = ip;
                ipText.classList.add('ip-text');
                ipContainer.appendChild(ipText);

                const deleteIpButton = createButton('x', function() {
                    const index = ips.indexOf(ip);
                    if (index > -1) {
                        console.log(index);
                        ips.splice(index, 1);
                    }
                    ws.send(JSON.stringify({prsts:[{id:id,ips:ips}]}));
                    createIpList(expandCheckbox.checked);
                });
                deleteIpButton.classList.add('ip-delete-btn');
                ipContainer.appendChild(deleteIpButton);
            }



            const remainingIPs = actDev.filter(ip => !ips.includes(ip));

            const botIpListContainer = document.createElement('div');
            botIpListContainer.classList.add('bot-ip-list-container');
            ipListContainer.appendChild(botIpListContainer);

            const divider = document.createElement('div');
            divider.classList.add('divider');
            botIpListContainer.appendChild(divider);

            for (const ip of remainingIPs) {
                const ipContainer = document.createElement('div');
                ipContainer.classList.add('ip-container');
                botIpListContainer.appendChild(ipContainer);

                const ipText = document.createElement('span');
                ipText.innerHTML = ip;
                ipText.classList.add('ip-text');
                ipContainer.appendChild(ipText);

                const addIpButton = createButton('+', function() {
                    ips.push(ip);
                    ws.send(JSON.stringify({prsts:[{id:id,ips:ips}]}));
                    createIpList(expandCheckbox.checked);
                });
                addIpButton.classList.add('ip-add-btn');
                ipContainer.appendChild(addIpButton);
            }

            const toggleVisibility = function(animate = true) {
                const value = expandCheckbox.checked;

                if (value) {
                    expandSection(botIpListContainer, animate);
                } else {
                    collapseSection(botIpListContainer, animate);
                }

                // botIpListContainer.style.display = value ? 'block' : 'none';
            }

            const buttonContainer = document.createElement('div');
            buttonContainer.classList.add('preset-btn-container');
            ipListContainer.appendChild(buttonContainer);

            const expandCheckbox = document.createElement('input');
            expandCheckbox.type = 'checkbox';
            expandCheckbox.checked = expanded;
            expandCheckbox.onchange = toggleVisibility;
            expandCheckbox.classList.add('expand-checkbox');
            buttonContainer.appendChild(expandCheckbox);

            toggleVisibility(false);

            const useButton = createButton('use', function() {
                ws.send(JSON.stringify({prstId:id}));

                // TODO: update ui to use new preset
                // location.reload();
            });
            useButton.classList.add('preset-use-btn');
            buttonContainer.appendChild(useButton);
        };

        createIpList();
    }
}



function updatePlaylistList() {
    const pllsts = currentCfg['pllsts'];
    const parent = document.getElementById('playlists-list');
    parent.replaceChildren(); // remove all children

    for (var i = 0; i < pllsts.length; i++) {
        const pllst = pllsts[i];
        const id = pllst['id']; // TODO: add defaults
        const n = pllst['n'];
        const pIds = pllst['pIds'] || [];



        const spacingContainer = document.createElement('div');
        parent.appendChild(spacingContainer);

        const playlistContainer = document.createElement('div');
        playlistContainer.classList.add('card');
        playlistContainer.classList.add('palette');
        spacingContainer.appendChild(playlistContainer);

        const playlistHeader = document.createElement('div');
        playlistHeader.classList.add('vd-header');
        playlistContainer.appendChild(playlistHeader);

        const nameInput = document.createElement('h2');
        nameInput.innerHTML = n;
        nameInput.classList.add('name-input');
        const submitName = function() {
            nameInput.contentEditable = 'false';

            const value = nameInput.innerHTML;
            pllst['n'] = value;
            ws.send(JSON.stringify({pllsts:[{id:id,n:value}]}));
        };
        nameInput.addEventListener("keydown", function(event) {
            if (event.keyCode === 13) {
                event.preventDefault();
                submitName();
            }
        });
        nameInput.addEventListener('focusout', (event) => {
            submitName();
        });
        nameInput.disabled = true;
        playlistHeader.appendChild(nameInput);

        const editButton = createButton('', function() {
            nameInput.contentEditable = 'true';
            nameInput.focus();
            var range = document.createRange()
            var sel = window.getSelection()

            range.setStart(nameInput.childNodes[0], nameInput.childNodes[0].length)
            range.collapse(true)

            sel.removeAllRanges()
            sel.addRange(range)
        });
        editButton.classList.add('edit-btn');
        playlistHeader.appendChild(editButton);

        const deleteButton = createButton('', function() {
            const pllstIds = currentCfg['pllstIds'];

            const idIndex = pllstIds.indexOf(id);
            if (idIndex > -1) {
                pllstIds.splice(idIndex, 1);
            }

            const pllstIndex = pllsts.map(pllst => pllst.id).indexOf(id);
            if (pllstIndex > -1) {
                pllsts.splice(pllstIndex, 1);
            }

            console.log({pllstIds:pllstIds});
            ws.send(JSON.stringify({pllstIds:pllstIds}));

            updatePlaylistList();
        });
        deleteButton.classList.add('delete-btn1');
        // deleteButton.classList.add('palette-delete-btn');
        playlistHeader.appendChild(deleteButton);


        const playlistBody = document.createElement('div');
        playlistBody.classList.add('preset-body');
        playlistContainer.appendChild(playlistBody);


        const presetListContainer = document.createElement('div');
        playlistBody.appendChild(presetListContainer);


        const createPresetList = function(expanded = false) {
            presetListContainer.replaceChildren();

            const topPresetListContainer = document.createElement('div');
            presetListContainer.appendChild(topPresetListContainer);
            for (const presetId of pIds) {
                const presetContainer = document.createElement('div');
                presetContainer.classList.add('ip-container');
                topPresetListContainer.appendChild(presetContainer);

                const presetNameText = document.createElement('span');
                var presetName = String(presetId);
                const preset = currentCfg['prsts'].find(prst => prst.id == presetId);
                if (preset) {
                    presetName = preset.n;
                }
                presetNameText.innerHTML = presetName;
                presetNameText.classList.add('ip-text');
                presetContainer.appendChild(presetNameText);

                const deletePresetButton = createButton('x', function() {
                    const index = pIds.indexOf(presetId);
                    if (index > -1) {
                        console.log(index);
                        pIds.splice(index, 1);
                    }
                    ws.send(JSON.stringify({pllsts:[{id:id,pIds:pIds}]}));
                    createPresetList(expandCheckbox.checked);
                });
                deletePresetButton.classList.add('ip-delete-btn');
                presetContainer.appendChild(deletePresetButton);
            }


            const prstIds = currentCfg['prstIds'];
            const remainingPresetIds = prstIds.filter(id => !pIds.includes(id));

            const botPresetListContainer = document.createElement('div');
            botPresetListContainer.classList.add('bot-ip-list-container');
            presetListContainer.appendChild(botPresetListContainer);

            const divider = document.createElement('div');
            divider.classList.add('divider');
            botPresetListContainer.appendChild(divider);

            for (const presetId of remainingPresetIds) {
                const presetContainer = document.createElement('div');
                presetContainer.classList.add('ip-container');
                botPresetListContainer.appendChild(presetContainer);

                const presetNameText = document.createElement('span');
                var presetName = String(presetId);
                const preset = currentCfg['prsts'].find(prst => prst.id == presetId);
                if (preset) {
                    presetName = preset.n;
                }
                presetNameText.innerHTML = presetName;
                presetNameText.classList.add('ip-text');
                presetContainer.appendChild(presetNameText);

                const addPresetButton = createButton('+', function() {
                    pIds.push(presetId);
                    ws.send(JSON.stringify({pllsts:[{id:id,pIds:pIds}]}));
                    createPresetList(expandCheckbox.checked);
                });
                addPresetButton.classList.add('ip-add-btn');
                presetContainer.appendChild(addPresetButton);
            }

            const toggleVisibility = function(animate = true) {
                const value = expandCheckbox.checked;

                if (value) {
                    expandSection(botPresetListContainer, animate);
                } else {
                    collapseSection(botPresetListContainer, animate);
                }

                // botIpListContainer.style.display = value ? 'block' : 'none';
            }

            const buttonContainer = document.createElement('div');
            buttonContainer.classList.add('preset-btn-container');
            presetListContainer.appendChild(buttonContainer);

            const expandCheckbox = document.createElement('input');
            expandCheckbox.type = 'checkbox';
            expandCheckbox.checked = expanded;
            expandCheckbox.onchange = toggleVisibility;
            expandCheckbox.classList.add('expand-checkbox');
            buttonContainer.appendChild(expandCheckbox);

            toggleVisibility(false);

            const useButton = createButton('use', function() {
                ws.send(JSON.stringify({prstId:id}));
                // TODO: update ui to use new preset
            });
            useButton.classList.add('preset-use-btn');
            buttonContainer.appendChild(useButton);
        };

        createPresetList();
    }
}




function collapseSection(element, animate) {
    var sectionHeight = element.scrollHeight;

    var elementTransition = element.style.transition;
    element.style.transition = 'none';

    if (animate) {
        requestAnimationFrame(function() {
            element.style.height = sectionHeight + 'px';
            element.style.transition = elementTransition;

            requestAnimationFrame(function() {
                element.style.height = 0 + 'px';
            });
        });
    } else {
        requestAnimationFrame(function() {
            element.style.height = 0 + 'px';

            requestAnimationFrame(function() {
                element.style.transition = elementTransition;
            });
        });
    }

    element.setAttribute('data-collapsed', 'true');
}

function expandSection(element, animate) {
    var sectionHeight = element.scrollHeight;

    if (animate) {
        element.style.height = sectionHeight + 'px';
    } else {
        var elementTransition = element.style.transition;
        element.style.transition = 'none';

        requestAnimationFrame(function() {
            element.style.height = sectionHeight + 'px';

            requestAnimationFrame(function() {
                element.style.transition = elementTransition;
            });
        });
    }

    element.setAttribute('data-collapsed', 'false');
};

function addPreset() {
    console.log('add preset');

    const prstIds = currentCfg['prstIds'];

    const id = generateId(prstIds);
    prstIds.push(id);

    const newPrst = {id:id,n:`Preset #${id}`};
    const prsts = currentCfg['prsts'];
    prsts.push(newPrst);

    ws.send(JSON.stringify({prstIds:prstIds,prsts:[newPrst]}));
    updatePresetList();
    updatePresetChips();
    updatePlaylistList();
};

function addPlaylist() {
    console.log('add playlist');

    const pllstIds = currentCfg['pllstIds'];

    const id = generateId(pllstIds);
    pllstIds.push(id);

    const newPllst = {id:id,n:`Playlist #${id}`};
    const pllsts = currentCfg['pllsts'];
    pllsts.push(newPllst);

    ws.send(JSON.stringify({pllstIds:pllstIds,pllsts:[newPllst]}));
    updatePlaylistList();
};


function toggleOnOff(e) {
    console.log('on/off');

    const value = !e.classList.contains('vd-btn-on');
    ws.send(JSON.stringify({on:value}));

    if (value) {
        e.classList.remove('vd-btn-off');
        e.classList.add('vd-btn-on');
    } else {
        e.classList.remove('vd-btn-on');
        e.classList.add('vd-btn-off');
    }
};


function navigation(val) {
    console.log(`navigate to ${val}`);

    const mainElements = [
        document.getElementById('vds-div'),
        document.getElementById('palettes-div'),
        document.getElementById('presets-div'),
        document.getElementById('playlists-div'),
    ];

    const mainElementsVisible = [
        [true, false, false, false],
        [false, true, false, false],
        [false, false, true, true]
    ];

    if (val == 3) {
        window.location.href = 'settings';
    } else {
        const currentMainElementsVisible = mainElementsVisible[val];

        for (let i = 0; i < mainElements.length; i++) {
            mainElements[i].style.display = currentMainElementsVisible[i] ? 'block' : 'none';
        }
    }
};

        </script>

        <link rel="stylesheet" href="grapick.min.css">
        <script src="grapick.min.js"></script>
    </head>
    <body>
        <div id="content">
            <div class="header">
                <h1 class="header-title">SyncLED</h1>
                <button id="power-btn" class="power-btn vd-btn-on" onclick="toggleOnOff(this)"></button>
            </div>
            <div id="preset-chips" class="chip-container">
            </div>
            <div id="vds-div">
                <div id="vds-list">
                </div>
                <button class="vd-add-btn" onclick="addVD()"></button>
            </div>
            <div id="palettes-div">
                <div id="palettes-list">
                </div>
                <button class="vd-add-btn" onclick="addPalette()"></button>
            </div>
            <div id="presets-div">
                <div id="presets-list">
                </div>
                <button class="vd-add-btn" onclick="addPreset()"></button>
            </div>
            <div id="playlists-div">
                <div id="playlists-list">
                </div>
                <button class="vd-add-btn" onclick="addPlaylist()"></button>
            </div>
            <div class="footer">
                <button class="footer-btn footer-btn-devs" onclick="navigation(0)"></button>
                <button class="footer-btn footer-btn-palettes" onclick="navigation(1)"></button>
                <button class="footer-btn footer-btn-presets" onclick="navigation(2)"></button>
                <button class="footer-btn footer-btn-settings" onclick="navigation(3)"></button>
            </div>
        </div>
    </body>
</html>
