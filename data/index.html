<html>
    <head>
        <link rel="stylesheet" href="index.css">
        <script>
var ws = new WebSocket("ws://192.168.3.9/ws");

// createInterface(JSON.parse('{}'));

const EFFECT_IDS = [1, 2, 4];
const EFFECT_NAMES = ['Cycle', 'Dot', 'Firework'];

var PALETTE_IDS = [];
var PALETTE_NAMES = [];

var currentCfg = {};

ws.onopen = function() {
    console.log("ws opened");
};

ws.onmessage = function(evt) {
    console.log("ws message");

    var msg = evt.data;
    console.log(msg);

    currentCfg = JSON.parse(msg);

    updatePalettes(currentCfg);
    createInterface(currentCfg);
};

ws.onclose = function() {
    console.log("ws closed");
};

function jsonButtonClick() {
    var jsonTextArea = document.getElementById("jsonTextArea");
    var jsonText = jsonTextArea.value;

    ws.send(jsonText);
};

function updatePalettes(cfg) {
    const ps = cfg['ps'];

    var ids = [];
    var names = [];

    for (var i = 0; i < ps.length; i++) {
        const p = ps[i];
        const id = parseInt(p['id']);
        const name = p['n'];

        ids.push(id);
        names.push(name);
    }

    PALETTE_IDS = ids;
    PALETTE_NAMES = names;
};

function createInterface(cfg) {
    const vds = cfg['vds'];
    const ps = cfg['ps'];
    const prstIds = cfg['prstIds'];
    const prsts = cfg['prsts'];

    var contentElement = document.getElementById("content");

    for (var i = 0; i < vds.length; i++) {
        const vd = vds[i];
        const vdElement = createVDInterface(vd);
        vdElement.classList.add('vd');

        contentElement.appendChild(vdElement);
    }

    for (var i = 0; i < ps.length; i++) {
        const p = ps[i];
        createPaletteInterface(p, contentElement);
    }

    contentElement.appendChild(createButton('+', function() {
        const id = parseInt(Math.random() * 100000);
        const name = `#${id}`;
        const ks = [];

        var newIds = currentCfg['pIds'];
        newIds.push(id);
        ws.send(JSON.stringify({pIds:newIds,ps:[{id:id,n:name,ks:ks}]}));
    }));


    createPresetInterface(prstIds, prsts, contentElement);
};

function createVDInterface(vd) {
    const id = vd['id'];
    const sI = vd['sI'];
    const eI = vd['eI'];
    const eId = vd['eId'];
    const eD = vd['eD'];
    const pId = vd['pId'];

    var root = document.createElement('div');
    var effectDataElem = createEffectInterface(eId, id, eD);

    /*
    root.appendChild(createSlider(0, 180, sI, function() {
        const value = parseInt(this.value);
        console.log(`StartIndex: ${this.value}`);
        ws.send(JSON.stringify({vds:[{id:id,sI:value}]}));
    }));

    root.appendChild(createSlider(0, 180, eI, function() {
        const value = parseInt(this.value);
        console.log(`EndIndex: ${this.value}`);
        ws.send(JSON.stringify({vds:[{id:id,eI:value}]}));
    }));
    */

    root.appendChild(createDualSlider(0, 180, sI, eI, function() {
        const value = parseInt(this.value);
        console.log(`StartIndex: ${value}`);
        console.log(JSON.stringify({vds:[{id:id,sI:value}]}));
        ws.send(JSON.stringify({vds:[{id:id,sI:value}]}));
    }, function(val) {
        const value = parseInt(this.value);
        console.log(`EndIndex: ${value}`);
        ws.send(JSON.stringify({vds:[{id:id,eI:value}]}));
    }));

    root.appendChild(createDropdown(EFFECT_IDS, EFFECT_NAMES, eId, function() {
        const value = parseInt(this.value);
        console.log(`Effect: ${value}`);
        ws.send(JSON.stringify({vds:[{id:id,eId:value}]}));

        // update ui
        var effectDataElem1 = createEffectInterface(value, id, {});
        root.replaceChild(effectDataElem1, effectDataElem);
        effectDataElem = effectDataElem1;
    }));

    root.appendChild(createDropdown(PALETTE_IDS, PALETTE_NAMES, pId, function() {
        const value = parseInt(this.value);
        console.log(`Palette: ${value}`);
        ws.send(JSON.stringify({vds:[{id:id,pId:value}]}));
    }));

    root.appendChild(createButton('-', function() {
        console.log(`Delete ${id}`);

        var newIds = Array.from(currentCfg['vdIds']);
        const index = newIds.indexOf(id);
        if (index > -1) {
            newIds.splice(index, 1);
        }
        console.log(index);
        console.log(JSON.stringify({vdIds:newIds}));
        ws.send(JSON.stringify({vdIds:newIds}));

        var contentElement = document.getElementById("content");
        content.removeChild(root);
    }));

    root.appendChild(effectDataElem);

    return root;
};

function createPaletteInterface(p, parent) {
    const id = p['id'];
    const name = p['n'];
    const ks = p['ks'];

    var root = document.createElement('div');

    var idElem = document.createElement('span');
    idElem.innerHTML = id;
    root.appendChild(idElem);

    var nameElem = document.createElement('input');
    nameElem.value = name;
    root.appendChild(nameElem);

    root.appendChild(createButton("set", function() {
        const value = nameElem.value;
        p.n = value;
        ws.send(JSON.stringify({ps:[p]}));
    }));

    root.appendChild(createButton('-', function() {
        console.log(`Delete ${id}`);

        var newIds = Array.from(currentCfg['pIds']);
        const index = newIds.indexOf(id);
        if (index > -1) {
            newIds.splice(index, 1);
        }
        console.log(index);
        console.log(JSON.stringify({pIds:newIds}));
        ws.send(JSON.stringify({pIds:newIds}));

        var contentElement = document.getElementById("content");
        content.removeChild(root);
    }));

    root.appendChild(createColorPicker(ks, root, function(val) {
        console.log('color change: ');
        console.log(val);
        ws.send(JSON.stringify({ps:[{id:id,ks:val}]}));
    }));

    parent.appendChild(root);
};

function createPresetInterface(prstIds, prsts, parent) {
    var root = document.createElement('div');

    if (!prsts) {
        return;
    }

    for (var i = 0; i < prsts.length; i++) {
        const prst = prsts[i];

        const id = prst.id;
        const name = prst.n;
        const cntrs = prst.cntrs;

        const j = i;

        const presetElem = document.createElement('div');
        root.appendChild(presetElem);

        presetElem.appendChild(createButton(id, function() {
            ws.send(JSON.stringify({prstId:id}));
        }));

        const nameElem = document.createElement('input');
        nameElem.value = name;
        presetElem.appendChild(nameElem);

        presetElem.appendChild(createButton("set", function() {
            const value = nameElem.value;
            prst.n = value;
            console.log(JSON.stringify({pstrs:[prst]}));
            ws.send(JSON.stringify({prsts:[prst]}));
        }));

        presetElem.appendChild(createButton('-', function() {
            const index = prstIds.indexOf(id);
            if (index > -1) {
                prstIds.splice(index, 1);
            }
            ws.send(JSON.stringify({prstIds:prstIds}));
            root.removeChild(presetElem);
        }));
    }

    root.appendChild(createButton('+', function() {
        const id = parseInt(Math.random() * 100000000);
        const name = `#${id}`;
        prstIds.push(id);
        prsts.push({id:id,n:name});
        ws.send(JSON.stringify({prstIds:prstIds,prsts:[{id:id,n:name}]}));
        parent.removeChild(root);
        createPresetInterface(prstIds, prsts, parent);
    }));

    parent.appendChild(root);
}

function createSlider(min, max, current, oninput) {
    var element = document.createElement('input');
    element.type = 'range';
    element.min = min;
    element.max = max;
    element.value = current;
    element.onchange = oninput;

    return element;
};

function createDualSlider(min, max, current1, current2, oninput1, oninput2) {
    var element = document.createElement('span');
    element.classList.add('multi-range');

    var input1 = document.createElement('input');
    var input2 = document.createElement('input');

    const adjustBackground = function() {
        var lower = input1.value;
        var upper = input2.value;

        var p1 = (lower - min) / (max - min) * 100;
        var p2 = (upper - min) / (max - min) * 100;
        input1.style.background = `linear-gradient(to right, #ddd ${p1}%, #39e ${p1}%, #39e ${p2}%, #ddd ${p2}%) no-repeat center`;
        input1.style.backgroundSize = '100% 2px';
        input1.style.backgroundOrigin = 'content-box';
    }

    input1.type = 'range';
    input1.min = min;
    input1.max = max;
    input1.value = current1;
    input1.oninput = function() {
        var lowerVal = parseInt(input1.value);
        var upperVal = parseInt(input2.value);

        if (lowerVal >= upperVal) {
            input1.value = upperVal - 1;
        }

        adjustBackground();
    };
    input1.onchange = oninput1;
    element.appendChild(input1);

    input2.type = 'range';
    input2.min = min;
    input2.max = max;
    input2.value = current2;
    input2.oninput = function() {
        var lowerVal = parseInt(input1.value);
        var upperVal = parseInt(input2.value);

        if (upperVal <= lowerVal) {
            input2.value = lowerVal + 1;
        }

        adjustBackground();
    };
    input2.onchange = oninput2;
    element.appendChild(input2);

    adjustBackground();

    return element;
};

function createColorPicker(ks, parent, onchange) {
    var element = document.createElement('span');

    var bgElem;

    const adjustBackground = function() {
        var newKs = Array.from(ks);
        newKs.sort(function(a, b) {{return a.p - b.p}});

        if (newKs.length == 1) {
            const c = newKs[0].c;
            const color = '#' + c.toString(16).padStart(6, '0');

            var colorText = `linear-gradient(to right,${color} 0%, ${color} 100%) no-repeat center`;
        } else if (newKs.length > 1) {
            const leftmost = newKs[0];
            const rightmost = newKs[newKs.length - 1];

            var r1 = (leftmost.c >> 16) & 0xFF;
            var g1 = (leftmost.c >> 8) & 0xFF;
            var b1 = leftmost.c & 0xFF;

            var r2 = (rightmost.c >> 16) & 0xFF;
            var g2 = (rightmost.c >> 8) & 0xFF;
            var b2 = rightmost.c & 0xFF;

            var p1 = (1.0 - rightmost.p) / (1.0 - rightmost.p + leftmost.p);
            var p2 = 1.0 - p1;

            var r3 = parseInt(p1 * r1 + p2 * r2);
            var g3 = parseInt(p1 * g1 + p2 * g2);
            var b3 = parseInt(p1 * b1 + p2 * b2);

            var newColor = (r3 << 16) | (g3 << 8) | b3;
            const color = '#' + newColor.toString(16).padStart(6, '0');

            var colorText = `linear-gradient(to right, ${color} 0%`;

            for (var i = 0; i < newKs.length; i++) {
                const p = newKs[i].p;
                const c = newKs[i].c;

                const perc = p * 100;
                const color = '#' + c.toString(16).padStart(6, '0');

                colorText += `,${color} ${perc}%`;
            }

            colorText += `, ${color} 100%) no-repeat center`;
        }

        if (bgElem) {
            bgElem.style.background = colorText;
            bgElem.style.backgroundSize = '100% 10px';
            bgElem.style.backgroundOrigin = 'content-box';
        }
    }

    var selectedIndex = -1;

    var colorPicker = document.createElement('input');
    colorPicker.type = 'color';
    colorPicker.onchange = function() {
        if (selectedIndex < 0) {
            return;
        }

        const value = parseInt(this.value.substring(1), 16);
        ks[selectedIndex].c = value;

        adjustBackground();
        onchange(ks);
    };

    var inputContainer = document.createElement('div');
    inputContainer.classList.add('color-picker');

    for (var i = 0; i < ks.length; i++) {
        const p = ks[i].p;
        const c = ks[i].c;

        const j = i;

        const input = document.createElement('input');
        input.type = 'range';
        input.min = 0;
        input.max = 99;
        input.value = p * 100;
        input.oninput = function() {
            const value = this.value / 100.0;
            ks[j].p = value;

            adjustBackground();
        };
        input.onchange = function() {
            const value = this.value / 100.0;
            ks[j].p = value;

            onchange(ks);
        };
        input.onfocus = function() {
            selectedIndex = j;
            colorPicker.value = '#' + ks[j].c.toString(16).padStart(6, '0');
        };

        inputContainer.appendChild(input);
    }

    element.appendChild(inputContainer);
    element.appendChild(colorPicker);
    element.appendChild(createButton('+', function() {
        ks.push({p:0.0,c:255});
        ks.sort(function(a, b) {{return a.p - b.p}});
        parent.replaceChild(createColorPicker(ks, parent, onchange), element);
        onchange(ks);
    }));
    element.appendChild(createButton('-', function() {
        if (selectedIndex < 0) {
            return;
        }

        ks.splice(selectedIndex, 1);
        parent.replaceChild(createColorPicker(ks, parent, onchange), element);
        onchange(ks);
    }));

    bgElem = inputContainer.children[0];
    adjustBackground();

    return element;
}

function createDropdown(values, names, current, onchange) {
    var element = document.createElement('select');

    for (var i = 0; i < values.length; i++) {
        var optionElem = document.createElement('option');
        optionElem.value = values[i];
        optionElem.text = names[i];
        element.appendChild(optionElem);
    }

    element.value = current;
    element.onchange = onchange;

    return element;
};

function createButton(text, onclick) {
    var element = document.createElement('button');
    element.innerHTML = text;
    element.onclick = onclick;

    return element;
}

function createEffectInterface(eId, id, eD) {
    var root = document.createElement('div');
    root.style = 'display: flex; flex-direction: column;';

    if (eId == 1 || eId == 2) { // all cyclic effects
        const defD = (eD['d'] || 2000) / 100.0;
        const defSP = (eD['sP'] || 0) * 100;
        const defEP = (eD['eP'] || 1.0) * 100;

        root.appendChild(createSlider(10, 100, defD, function() {
            const value = parseInt(this.value);
            const ms = value * 100;
            console.log(`Duration: ${ms}`);
            ws.send(JSON.stringify({vds:[{id:id,eD:{d:ms}}]}));
        }));

        /*
        root.appendChild(createSlider(0, 100, defSP, function() {
            const value = parseInt(this.value);
            const sP = value / 100.0;
            console.log(`StartPos: ${sP}`);
            ws.send(JSON.stringify({vds:[{id:id,eD:{sP:sP}}]}));
        }));

        root.appendChild(createSlider(0, 100, defEP, function() {
            const value = parseInt(this.value);
            const eP = value / 100.0;
            console.log(`EndPos: ${eP}`);
            ws.send(JSON.stringify({vds:[{id:id,eD:{eP:eP}}]}));
        }));
        */

        root.appendChild(createDualSlider(0, 100, defSP, defEP, function() {
            const value = parseInt(this.value);
            const sP = value / 100.0;
            console.log(`StartPos: ${sP}`);
            ws.send(JSON.stringify({vds:[{id:id,eD:{sP:sP}}]}));
        }, function() {
            const value = parseInt(this.value);
            const eP = value / 100.0;
            console.log(`EndPos: ${eP}`);
            ws.send(JSON.stringify({vds:[{id:id,eD:{eP:eP}}]}));
        }));
    } else if (eId == 4) { // all simulation effects
        const defS = (eD['s'] || 1.0) * 10;

        root.appendChild(createSlider(1, 50, defS, function() {
            const value = parseInt(this.value);
            const s = value / 10.0;
            console.log(`Speed: ${s}`);
            ws.send(JSON.stringify({vds:[{id:id,eD:{s:s}}]}));
        }));
    }

    // effect specific
    if (eId == 2) {
        const defS = (eD['s'] || 1.0) * 10;

        root.appendChild(createSlider(0, 500, defS, function() {
            const value = parseInt(this.value);
            const s = value / 10.0;
            console.log(`Size: ${s}`);
            ws.send(JSON.stringify({vds:[{id:id,eD:{s:s}}]}));
        }));
    }

    return root;
};
        </script>
    </head>
    <body>
        <label for="jsonTextArea">Json Config:</label>
        <textarea id="jsonTextArea" name="jsonTextArea" rows="8" cols="100">
        </textarea>
        <button onclick="jsonButtonClick()">Set</button>
        <div id="content"></div>
    </body>
</html>
